インターネットアクセスができない AWS VPC 内で Jenkins を使用しており、Jenkins 本体や多数のプラグインをアップグレードする必要がある場合でも、インターネットに接続できる環境を使った準備をすれば対応可能です。以下に、Jenkins の **本体のバージョンアップ**と**プラグインのアップグレード**をオフライン環境で行う手順を詳細に説明します。

---
## **1. 作業の概要**
本手順では、以下の流れに沿って作業を進めます。
1. [現環境の情報収集とバックアップ](#1-現環境の情報収集とバックアップ)
2. [必要なファイルの準備（インターネット接続環境での作業）](#2-必要なファイルの準備インターネット接続環境での作業)
3. [Jenkins 本体のアップグレード](#3-jenkins-本体のアップグレード)
4. [プラグインのアップグレード](#4-プラグインのアップグレード)
5. [動作確認・トラブルシューティング](#5-動作確認トラブルシューティング)
---
## **1. 現環境の情報収集とバックアップ**
1. **システム構成の確認**
   - Jenkins の現在のバージョン: `2.277.4`
   - Jenkins データフォルダ（`$JENKINS_HOME`）の場所:
     - デフォルトでは `C:\ProgramData\Jenkins` に保存されています。
   - EC2 Instance にインストール済みの **Java のバージョン**を確認します:
     ```cmd
     java -version
     ```
     - **Jenkins 2.492.2 LTS** は最低でも **Java 11** が必要です。Java 11 がインストールされていない場合は、後述する手順で対応します。
2. **フルバックアップ**
   - `$JENKINS_HOME` ディレクトリ（`C:\ProgramData\Jenkins` など）を丸ごとバックアップします。
     - 必須バックアップ項目:
       - `config.xml`（システム設定）
       - `jobs/`（ジョブ設定データ）
       - `plugins/`（インストール済みプラグイン）
       - `users/`（Jenkins ユーザーと権限設定）
       - `secrets/`（認証情報など）
   - 万一の問題に備え、EC2 インスタンスのスナップショットも取得しておきます。
3. **インストール済みプラグインのリストを取得**
   - Jenkins の UI からプラグイン一覧を確認する:
     1. Jenkins 管理画面 > `プラグインの管理 > インストール済み` に移動。
     2. プラグイン名とバージョンのリストが出力されているかチェック。
   - **または CLI ですべてのプラグイン情報を取得:**
     1. PowerShell またはコマンドプロンプトを開き、以下を実行:
        ```cmd
        java -jar jenkins-cli.jar -s http://<JenkinsサーバーのIP>:8080/ list-plugins
        ```
        Jenkins CLI を使ってインストール済みプラグイン一覧が取得可能。
     2. 結果をファイルに保存しておく（例: plugins.txt）。
---
## **2. 必要なファイルの準備（インターネット接続環境での作業）**
### **2-1. Jenkins 本体の新バージョンをダウンロード**
1. インターネットが使える環境から、[Jenkins LTS ダウンロードページ](https://www.jenkins.io/download/lts/) にアクセスします。
2. **Jenkins 2.492.2 LTS** の `jenkins.war` ファイルをダウンロードします。
3. ダウンロードした `jenkins.war` をオフライン環境に持ち込む（S3 バケット経由や AWS Systems Manager を利用）。
---
### **2-2. プラグインアップグレード用ファイルを準備**
Jenkins はバージョンが変わると、既存プラグインの互換性が崩れることがあるため、**最新版のプラグインを準備**します。
1. **オンライン環境からプラグインの最新版を一括ダウンロードする**
   - プラグインをダウンロードするスクリプトを使用します。[Jenkins CLI](https://www.jenkins.io/doc/book/managing/cli/) が必要です。
   1. CLI をダウンロードして任意のディレクトリに保存。
   2. 以下のスクリプトを実行:
      ```bash
      # 必須プラグインを一括ダウンロード
      for plugin in $(cat plugins.txt); do 
          curl -O https://updates.jenkins.io/latest/${plugin}.hpi
      done
      ```
      - `plugins.txt` は事前に取得したプラグイン一覧ファイルです。
   3. ダウンロードした `.hpi` ファイルを Zip 圧縮してオフライン環境に持ち込みます。
2. 4. フライン環境に転送**
   - AWS Systems Manager または S3 を使用して、Zip ファイルを EC2 インスタンスに転送します。
---
## **3. Jenkins 本体のアップグレード**
1. **Jenkins サービスを停止**
   - Windows サービスマネージャー（`services.msc`）を開いて、`Jenkins` サービスを停止します。
   - もしくはコマンドプロンプトで以下を実行:
     ```cmd
     net stop jenkins
     ```
2. **新しい `jenkins.war` ファイルを設置**
   - 現在の Jenkins ディレクトリを確認（例: `C:\Program Files (x86)\Jenkins`）。
   - 古い `jenkins.war` をバックアップ（例: `jenkins.war.bak`）。
   - ダウンロード済みの `jenkins.war` をその場所にコピーします。
3. **Jenkins サービスを再起動**
   - サービスマネージャーで `Jenkins` サービスをスタートします。
   - またはコマンドラインで以下を実行:
     ```cmd
     net start jenkins
     ```
4. **アップグレードを確認**
   - ブラウザで Jenkins にアクセス（例: `http://<JenkinsサーバーのIP>:8080/`）。
   - ダッシュボード右下のバージョン番号が `2.492.2` になっていることを確認してください。
---
## **4. プラグインのアップグレード**
1. **プラグインファイルを配置**
   - ダウンロードして持ち込んだ `.hpi` ファイルを Jenkins のプラグインディレクトリ（通常は `C:\ProgramData\Jenkins\plugins`）に配置し、既存のプラグインファイルを上書きします。
2. **Jenkins サーバーの再起動**
   - 新しいプラグインを反映するには Jenkins を再起動する必要があります。
   - 再起動は、ブラウザで Jenkins にアクセスして以下の URL へ移動:
     ```
     http://<JenkinsサーバーのIP>:8080/restart
     ```
   - または Jenkins サービスを停止後、再起動します（`net stop jenkins` → `net start jenkins`）。
3. **インストールプラグインを確認**
   - Jenkins 管理画面 > 「プラグインの管理」 > 「インストール済み」 を確認し、全てのプラグインが最新化されていることを確認します。
---
## **5. 動作確認・トラブルシューティング**
1. **ジョブ動作確認**
   - 全てのジョブが正常に動作するかを確認します（例: ビルドのトリガー実行）。
   - ジョブ実行中にエラーが発生した場合、特定プラグインの不具合が原因となることが多いので該当プラグインを確認します。
2. **Jenkins ログチェック**
   - Jenkins ログファイル（例: `C:\ProgramData\Jenkins\jenkins.log`）を確認し、エラーが出力されていないか確認してください。
3. **バックアップからの復元**
   - 問題が発生した場合は、取得した `$JENKINS_HOME` のバックアップと旧バージョンの `jenkins.war` を使用してロールバックを行います。
---
## **注意点**
- **オフライン環境の特徴**:
  - 互換性のないプラグインが残っていると Jenkins が正常動作しない可能性が高いです。そのため、全プラグインの更新を確実に行うことが重要です。
- **Java バージョン**:
  - Java 11 以降が必要なため、インストールされていない場合は AdoptOpenJDK 11（または OpenJDK 11）を事前にインストールして環境変数を設定してください。
これらの手順を踏むことで、安全に Jenkins 本体とプラグインをオフライン環境でアップグレード可能です。