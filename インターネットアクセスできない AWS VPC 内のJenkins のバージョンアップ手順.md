インターネットアクセスできない AWS VPC 内の環境では、Jenkins 本体やプラグインの更新ファイルをインターネットに接続された別環境でダウンロードし、それを AWS VPC 内に持ち込むことでアップグレードを実施します。この条件を踏まえた Jenkins のバージョンアップ手順を以下に示します。

---
## **1. 事前準備**
### **1-1. システム構成の確認**
- **動作している Jenkins バージョン**: 2.277.4 LTS
- **アップグレード目標バージョン**: 2.492.2 LTS
- **現在の Java バージョンの確認**
  - Jenkins 2.492.2 LTS は **Java 11** が必須（Java 8 はサポート終了）。  
    - 確認コマンド: 
      ```cmd
      java -version
      ```
    - Java 11 が未インストールの場合は、後述する手順で事前に準備します。
### **1-2. バックアップの実施**
- Jenkins バージョンアップに伴い、不測の事態が発生した場合に備えて、以下の情報をバックアップします。
  - `$JENKINS_HOME` ディレクトリ（Windows の場合、通常は `C:\ProgramData\Jenkins`）
    - バックアップ対象:
      - **ジョブデータ** (`jobs/`)
      - **プラグインフォルダ** (`plugins/`)
      - **システム設定** (`config.xml`)
      - **認証情報** (`secrets/` ディレクトリ)
      - **ユーザー情報** (`users/`)
  - EC2 インスタンスの AMI（Amazon Machine Image）またはスナップショットを作成する。
    - AWS Management Console からスナップショットを作成しておくと、問題が発生した場合に容易に復元できます。
---
## **2. オフライン環境向けのアップグレード準備**
### **2-1. Jenkins WAR ファイルのダウンロード**
1. オンラインアクセス可能な別環境（例: ローカルPC）から、[Jenkins LTS ダウンロードページ](https://www.jenkins.io/download/lts/) にアクセスします。
2. バージョン `2.492.2 LTS` の `jenkins.war` ファイルをダウンロードします。
3. ダウンロードした `jenkins.war` をオフライン環境（EC2 インスタンス）に持ち込む。
   - AWS Systems Manager (SSM) のファイル転送機能や、空の S3 バケットに一時的にアップロードして VPC 内からダウンロードする。
---
### **2-2. プラグインのダウンロード準備**
現在インストール済みプラグイン（約160個）のリストを取得し、そのアップデート版を事前にダウンロードします。
1. **インストール済みプラグインのリストをエクスポート**
   - Jenkins 管理画面 > 「プラグインの管理」 > 「インストール済み」タブで、インストール済みプラグインの一覧を手動で確認または以下の方法で取得:
     1. Jenkins のデータディレクトリ（通常は `$JENKINS_HOME/plugins`）に移動します。
     2. プラグイン一覧を取得するスクリプトの実行（Windows の場合、PowerShell などで実行可能）。
        ```powershell
        Get-ChildItem -Path "C:\ProgramData\Jenkins\plugins" -Include "*.jpi" | ForEach-Object { $_.BaseName }
        ```
2. **プラグインアップデート版の収集**
   - インストール済みプラグインと同じバージョン以上の互換性のあるプラグイン（オフライン用）をインターネット環境で以下の手順で取得:
     1. [Jenkins Plugin Index](https://plugins.jenkins.io/) にアクセス。
     2. 各プラグインの最新版（互換性あり）をダウンロード。
        - オフライン用 `.hpi` または `.jpi` ファイルを取得。
     3. プラグインファイルをまとめて ZIP ファイルなどに圧縮し、オフライン環境に持ち込む。
3. **アップデート版プラグインの転送**
   - 手順は `jenkins.war` を転送した方法と同様に実施します（Systems Manager、S3 などを利用）。
---
## **3. Jenkins の本体アップグレード**
### **3-1. Jenkins サービス停止**
1. EC2 インスタンスにリモートデスクトップ (RDP) で接続します。
2. Jenkins サービスを停止します:
   - Windows のサービスマネージャー（`services.msc`）を開き、`Jenkins` サービスを停止する。
   - またはコマンドラインで以下を実行:
     ```cmd
     net stop jenkins
     ```
### **3-2. Jenkins WAR ファイルの置き換え**
1. Jenkins がインストールされているディレクトリに移動します。
   - デフォルトでは `C:\Program Files (x86)\Jenkins` または `C:\Program Files\Jenkins` に配置されています。
2. 旧バージョンの `jenkins.war` をバックアップ:
   - 例: `jenkins.war.bak` とリネーム。
3. オフライン環境に転送済みの `jenkins.war`（バージョン 2.492.2）を配置。
### **3-3. Jenkins サービス再起動**
1. Jenkins サービスを起動します:
   - サービスマネージャーから起動。
   - またはコマンドラインで以下を実行:
     ```cmd
     net start jenkins
     ```
2. ブラウザで Jenkins にアクセスし（例: `http://<JenkinsサーバーのIP>:8080`）、バージョンアップが正常に完了したか確認します。
---
## **4. プラグインのアップグレード**
### **4-1. プラグインファイルの配置**
- Jenkins 管理画面でプラグインをオンラインで更新できないため、オフラインでの更新を手動で行います。
1. オフライン環境に転送した `.hpi` または `.jpi` ファイルを Jenkins プラグインディレクトリにコピーします:
   - ディレクトリ: `C:\ProgramData\Jenkins\plugins`
   - 既存プラグインの `.jpi` ファイルを上書きします。
2. Jenkins サーバーを再起動します。
### **4-2. プラグインアップデートの確認**
- 管理画面 > 「プラグイン管理」>「インストール済み」タブで更新されたプラグインのバージョンが反映されているか確認してください。
---
## **5. 動作確認・検証**
1. **ジョブの確認**
   - 全てのジョブが正常にビルドできるかを確認します。
2. **認証情報のチェック**
   - Credentials の設定が維持されているか確認します（シークレットキー関連にエラーがないか）。
3. **ログの確認**
   - Jenkins のログ（デフォルト: `C:\ProgramData\Jenkins\jenkins.log`）を確認し、エラーがないことを確認します。
---
## **6. ロールバック手順**
万が一アップグレードに失敗した場合は、以下を実施します。
1. Jenkins サービスを停止します。
2. バックアップした `$JENKINS_HOME` ディレクトリと旧バージョンの `jenkins.war` を元に戻します。
3. サービスを再起動し、正常に復元されるか確認します。
---
## **補足**
- Jenkins 本体だけでなく、約160個のプラグインが大きなバージョン差により非互換を起こす可能性があります。プラグインの互換性（Jenkins 更新による影響）を事前に調査しておくことを推奨します。
- AWS Systems Manager の Session Manager や S3 バケットを活用すると、安全かつ効率的にオフライン環境でファイルを転送できます。
以上がバージョンアップ手順となります。